<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í…ì¹´ í…œí”Œë¦¿ - ì—ë””í„° (Canvas + GIF)</title>
    <style>
        /* [1] ì›¹í°íŠ¸ ì •ì˜ */
        @font-face {
            font-family: 'PyeongtaekSunset';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408@1.0/PTNoeulL.woff2') format('woff2');
            font-weight: 300;
            font-display: swap;
        }
        @font-face {
            font-family: 'PyeongtaekSunset';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408@1.0/PTNoeulB.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }

        /* [2] ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        body { 
            margin: 0; padding: 0; 
            font-family: 'PyeongtaekSunset', sans-serif; 
            background-color: #e9ecef;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ëª¨ë°”ì¼ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        body.mobile-mode {
            flex-direction: column;
            overflow-y: auto;
            height: auto;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: #ffffff;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            z-index: 10;
        }
        .sidebar.right {
            border-right: none;
            border-left: 1px solid #dee2e6;
        }

        body.mobile-mode .sidebar {
            width: 100%;
            border: none;
            order: 2;
            box-sizing: border-box;
            overflow-y: visible;
        }

        /* ë©”ì¸ ì‘ì—… ì˜ì—­ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 40px;
            background-color: #ced4da;
            position: relative;
        }

        body.mobile-mode .main-content {
            order: 1;
            padding: 20px 0;
            min-height: 450px;
        }

        /* ì»¨íŠ¸ë¡¤ ê·¸ë£¹ */
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f3f5;
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #495057;
        }

        /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ */
        .canvas-container-wrapper {
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background-color: #fff;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }

        /* ë²„íŠ¼ ë° ì…ë ¥ì°½ */
        button { 
            width: 100%;
            padding: 10px; 
            font-size: 14px; 
            cursor: pointer; 
            border-radius: 6px; 
            border: 1px solid #ced4da; 
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        button:hover { opacity: 0.8; }
        .save-btn { background: #28a745; color: white; border: none; font-size: 16px; padding: 15px; margin-top: 10px; }
        .upload-btn { background: #007bff; color: white; border: none; }
        .font-btn { background: #6c757d; color: white; border: none; }
        .history-btn { background: #6c757d; color: white; border: none; font-size: 12px; padding: 8px; flex: 1; }
        
        .selector-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .selector-box label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            font-size: 14px;
        }

        .hint { color: #868e96; font-size: 12px; margin-top: 10px; line-height: 1.4; }
        
        /* í°íŠ¸ ì»¨íŠ¸ë¡¤ */
        .slider-item { margin: 8px 0; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .slider-item input[type="range"] { width: 100px; }
        .num-input { width: 50px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: white; z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- ë¡œë”© í™”ë©´ -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<aside class="sidebar">
    <div class="control-section">
        <div class="section-title">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ (GIF ì§€ì›)</div>
        <button class="upload-btn" onclick="document.getElementById('img-input-1').click();">ë§í’ì„  ì‚¬ì§„</button>
        <button class="upload-btn" onclick="document.getElementById('img-input-2').click();">í•¸ë“œí° ì‚¬ì§„</button>
        <button class="upload-btn" onclick="document.getElementById('img-input-3').click();">ë¡œê³  ì‚¬ì§„</button>
        <input type="file" id="img-input-1" accept="image/*" style="display:none">
        <input type="file" id="img-input-2" accept="image/*" style="display:none">
        <input type="file" id="img-input-3" accept="image/*" style="display:none">
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ•¹ï¸ ì¡°ì‘ ëŒ€ìƒ</div>
        <div class="selector-box">
            <label><input type="radio" name="target" value="none" checked> ì„ íƒ ì—†ìŒ</label>
            <label><input type="radio" name="target" value="layer1"> ë§í’ì„  ì‚¬ì§„</label>
            <label><input type="radio" name="target" value="layer2"> í•¸ë“œí° ì‚¬ì§„</label>
            <label><input type="radio" name="target" value="layer3"> ë¡œê³  ì‚¬ì§„</label>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 10px;">
                <button onclick="resetActiveObject()" style="font-size: 12px; padding: 5px;">ì´ˆê¸°í™”</button>
                <button onclick="rotateActiveObject()" style="font-size: 12px; padding: 5px;">íšŒì „</button>
                <button onclick="flipActiveObject()" style="font-size: 12px; padding: 5px;">ë°˜ì „</button>
            </div>
        </div>
        <div class="hint">ì´ë¯¸ì§€ë¥¼ ì§ì ‘ í´ë¦­í•˜ê±°ë‚˜ ë¼ë””ì˜¤ ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ í›„ ì¡°ì‘í•˜ì„¸ìš”.</div>
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ” SteamGridDB ê²€ìƒ‰</div>
        <input type="text" id="sgdb-input" placeholder="ê²Œì„ëª… ì…ë ¥" style="width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box;">
        <button class="upload-btn" id="sgdb-search-btn" style="background:#495057">ê²€ìƒ‰í•˜ê¸°</button>
    </div>
</aside>

<main class="main-content">
    <div class="canvas-container-wrapper" id="canvas-wrapper">
        <canvas id="c" width="1024" height="765"></canvas>
    </div>
</main>

<aside class="sidebar right">
    <div class="control-section">
        <div class="section-title">âš™ï¸ í™˜ê²½ ì„¤ì •</div>
        <label style="cursor:pointer; font-size: 14px; font-weight: bold; color: #007bff;">
            <input type="checkbox" id="mobile-mode-toggle"> ëª¨ë°”ì¼ ìµœì í™” UI ëª¨ë“œ
        </label>
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ”¤ í°íŠ¸ ì„¤ì •</div>
        <button class="font-btn" onclick="document.getElementById('font-input').click();">í°íŠ¸ ë³€ê²½</button>
        <input type="file" id="font-input" accept=".ttf, .otf, .woff, .woff2" style="display:none">
        
        <label style="display: flex; align-items: center; margin-top: 15px; font-weight: bold; font-size: 14px;">
            <input type="checkbox" id="auto-font-toggle" checked style="margin-right: 8px;"> ìë™ í¬ê¸° ì¡°ì ˆ
        </label>

        <div id="manual-font-controls" style="display: none; margin-top: 10px;">
            <div class="slider-item">ì¢Œìƒë‹¨: <input type="range" class="font-slider" data-id="text_tl" min="10" max="100" value="42"></div>
            <div class="slider-item">ì¢Œí•˜ë‹¨: <input type="range" class="font-slider" data-id="text_bl" min="10" max="100" value="42"></div>
            <div class="slider-item">ìš°ìƒë‹¨: <input type="range" class="font-slider" data-id="text_tr" min="10" max="100" value="42"></div>
        </div>
    </div>

    <div class="control-section">
        <div class="section-title">âœ¨ íš¨ê³¼ ì„¤ì •</div>
        <label style="cursor:pointer; font-size: 14px; display: block; margin-bottom: 8px;"><input type="checkbox" id="logo-shadow-toggle"> ë¡œê³  ê·¸ë¦¼ì íš¨ê³¼</label>
        <label style="cursor:pointer; font-size: 14px; display: block;"><input type="checkbox" id="logo-border-toggle"> ë¡œê³  í…Œë‘ë¦¬ ì„¤ì •</label>
        <div id="logo-border-controls" style="display: none; margin-top: 10px; font-size: 13px;">
            <div class="slider-item">ë‘ê»˜: <input type="range" id="logo-border-width" min="0" step="0.5" max="10" value="0"></div>
            <div class="slider-item">ìƒ‰ìƒ: <input type="color" id="logo-border-color" value="#000000"></div>
        </div>
    </div>

    <div style="margin-top: auto;">
        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
            <button class="history-btn" onclick="undo()">ë˜ëŒë¦¬ê¸°</button>
            <button class="history-btn" onclick="redo()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
        <button class="save-btn" id="save-btn">ìµœì¢… ê²°ê³¼ë¬¼ ì €ì¥ (GIF/PNG)</button>
        <div class="hint" style="text-align: center;">GIF í¬í•¨ ì‹œ ë Œë”ë§ì— ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.</div>
    </div>
</aside>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
<script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
<!-- GIF íŒŒì‹±ì„ ìœ„í•œ libgif (SuperGif) -->
<script src="https://cdn.jsdelivr.net/gh/buzzfeed/libgif-js@master/libgif.js"></script>
<!-- GIF ìƒì„±ì„ ìœ„í•œ gif.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

<script>
    // --- 1. Fabric Canvas ì´ˆê¸°í™” ---
    const canvas = new fabric.Canvas('c', {
        preserveObjectStacking: true, // ì„ íƒ ì‹œ ë§¨ ìœ„ë¡œ ì˜¬ë¼ì˜¤ëŠ” ë™ì‘ ë°©ì§€
        selection: false // ë‹¤ì¤‘ ì„ íƒ ë°©ì§€
    });
    
    // ë ˆì´ì–´ ê´€ë¦¬ ê°ì²´
    const layers = {
        img1: null, // ë§í’ì„  ì‚¬ì§„
        img2: null, // í•¸ë“œí° ì‚¬ì§„
        img3: null, // ë¡œê³  ì‚¬ì§„
        overlay: null, // í…ì¹´ ë°°ê²½ (ì¤‘ê°„ ë ˆì´ì–´)
        text_tl: null, // í…ìŠ¤íŠ¸
        text_bl: null,
        text_tr: null
    };

    // GIF ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ê´€ë¦¬
    const activeGifs = []; // { fabricObj, superGif, canvasEl }

    // --- 2. ê¸°ë³¸ ì„¸íŒ… (ë°°ê²½, í…ìŠ¤íŠ¸) ë¡œë“œ ---
    // í°íŠ¸ ë¡œë“œ ëŒ€ê¸° í›„ ì‹¤í–‰
    document.fonts.ready.then(() => {
        initCanvas();
    });

    function initCanvas() {
        // ë°°ê²½ ì´ë¯¸ì§€ (í…ì¹´.png) - ì¤‘ê°„ ì˜¤ë²„ë ˆì´ ì—­í• 
        // ê¸°ì¡´ HTML êµ¬ì¡°ìƒ: User Photos(z1-3) < Background(z4) < Text(z6)
        fabric.Image.fromURL('tenka.png', function(img) {
            img.set({
                left: 0, top: 0, selectable: false, evented: false,
                scaleX: 1, scaleY: 1
            });
            layers.overlay = img;
            canvas.add(img);
            canvas.sendToBack(img); // ì¼ë‹¨ ë’¤ë¡œ ë³´ë‚´ê³  ë‚˜ì¤‘ì— ì¡°ì •
            initTextLayers();
            createPlaceholders();
        }, { crossOrigin: 'anonymous' });
    }

    // ë¹ˆ í”Œë ˆì´ìŠ¤í™€ë”(ì´ë¯¸ì§€ ë“¤ì–´ê°ˆ ìë¦¬) ìƒì„± - ì¢Œí‘œê°’ ìœ ì§€
    function createPlaceholders() {
        // layer1: left 200, top 0, w 700, h 440
        // layer2: left 531, top 470, w 90, h 150
        // layer3: left 635, top 415, w 380, h 340
        // ì´ë¯¸ì§€ê°€ ì—†ì–´ë„ Z-index ìˆœì„œ ìœ ì§€ë¥¼ ìœ„í•´ í•„ìš”í•¨. 
        // Fabricì—ì„œëŠ” ê°ì²´ë¥¼ ì¶”ê°€í•œ ìˆœì„œëŒ€ë¡œ ê·¸ë ¤ì§€ë¯€ë¡œ, 
        // UserLayer 1,2,3 -> Overlay -> Text ìˆœì„œë¡œ add í•´ì•¼ í•¨.
        
        // í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•  ë•Œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ë¯€ë¡œ, 
        // ë Œë”ë§ ì‹œì ì— sendToBack ë“±ìœ¼ë¡œ ìˆœì„œë¥¼ ì œì–´í•©ë‹ˆë‹¤.
        // reorderLayers() í•¨ìˆ˜ì—ì„œ ì¼ê´„ ê´€ë¦¬.
    }

    function initTextLayers() {
        const commonStyle = {
            fontFamily: 'PyeongtaekSunset',
            fontWeight: 'bold',
            textAlign: 'center',
            fill: '#000000',
            lineHeight: 1.2,
            originX: 'left', originY: 'top',
            editable: true,
            splitByGrapheme: true,
            fontSize: 42
        };

        // TextboxëŠ” ìë™ ì¤„ë°”ê¿ˆ ì§€ì›
        layers.text_tl = new fabric.Textbox("í…ì¹´ì¨© ë°˜ë°•í•˜ëŠ” ë‚´ìš©Â·Â·Â·\në“£ê¸° ì‹«ì€ ë§Â·Â·Â·", {
            ...commonStyle,
            left: 1, top: 1, width: 215, height: 330,
            fixedHeight: 330 // ì»¤ìŠ¤í…€ ì†ì„±
        });

        layers.text_bl = new fabric.Textbox("ë‚˜ì¨© ë¯¸ì•ˆÂ·Â·Â· ì˜ ì•ˆ ë“¤ë ¤Â·Â·Â·\nì•„ë¬´íŠ¼ ì–´ì©Œêµ¬ ì €ì©Œêµ¬ í•œë°ë‹¤\nì´ëŸ¬ì €ëŸ¬í•˜ê³  ì´ë˜ì €ë˜\nì¥ì ì´ ë§ì•„ì„œ ì¬ë°ŒëŠ” ê²Œì„ì´ë¼ëŠ”\nì¥í™©í•œ ì„¤ëª…Â·Â·Â·", {
            ...commonStyle,
            left: 1, top: 420, width: 230, height: 350,
            fixedHeight: 350
        });

        layers.text_tr = new fabric.Textbox("ë‚˜ì¨© ì´ê±° ë´ë´Â·Â·Â·!\nëŒ€ì¶© ì–´ì©Œêµ¬ ì €ì©Œêµ¬\nê°“ê²œÂ·Â·Â·!", {
            ...commonStyle,
            left: 810, top: 1, width: 215, height: 410,
            fixedHeight: 410
        });

        [layers.text_tl, layers.text_bl, layers.text_tr].forEach(t => {
            canvas.add(t);
            t.on('changed', () => {
                autoResizeFont(t);
                saveHistory();
            });
            // í…ìŠ¤íŠ¸ ì„ íƒ ì‹œ í°íŠ¸ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
            t.on('selected', () => {
                // ì–´ë–¤ í…ìŠ¤íŠ¸ì¸ì§€ ì‹ë³„ ë¶ˆê°€í•˜ë¯€ë¡œ data-id ë§¤í•‘ í•„ìš”í•˜ë‚˜ ìƒëµ
            });
        });
        
        // ì´ˆê¸° í°íŠ¸ ë¦¬ì‚¬ì´ì§•
        autoResizeFont(layers.text_tl);
        autoResizeFont(layers.text_bl);
        autoResizeFont(layers.text_tr);
        reorderLayers();
    }

    // ë ˆì´ì–´ ìˆœì„œ ì •ë ¬ (ê°€ì¥ ì¤‘ìš”)
    function reorderLayers() {
        if (layers.img1) canvas.sendToBack(layers.img1);
        if (layers.img2) canvas.sendToBack(layers.img2);
        // img3(ë¡œê³ )ê°€ img1, img2ë³´ë‹¤ ìœ„ì— ìˆì–´ì•¼ í•˜ëŠ”ê°€? ì›ë³¸ CSSëŠ” 1, 2, 5(logo) ìˆœ.
        // User defined order: 1 (z1), 2 (z2), 3 (z5), BG (z4?? No, BG overlays photos).
        // ì›ë³¸ CSS: BG(z4), Logo(z5). Logo is ON TOP of BG. Photos are UNDER BG.
        
        // ìˆ˜ì •ëœ ë¡œì§: Photos < BG < Logo < Text
        if (layers.img1) layers.img1.moveTo(0);
        if (layers.img2) layers.img2.moveTo(1);
        if (layers.overlay) layers.overlay.moveTo(2); // ë°°ê²½ì´ ì‚¬ì§„ì„ ë®ìŒ (íˆ¬ëª… ì˜ì—­ìœ¼ë¡œ ì‚¬ì§„ ë³´ì„)
        if (layers.img3) layers.img3.moveTo(3); // ë¡œê³ ëŠ” ë°°ê²½ ìœ„ì— (ì›ë³¸ CSS z-index 5, BG z-index 4)
        
        [layers.text_tl, layers.text_bl, layers.text_tr].forEach(t => t.bringToFront());
        canvas.requestRenderAll();
    }

    // ìë™ í°íŠ¸ í¬ê¸° ì¡°ì ˆ
    const maxFontSize = 42;
    const minFontSize = 12;

    function autoResizeFont(textbox) {
        if (!document.getElementById('auto-font-toggle').checked) return;
        
        // í…ìŠ¤íŠ¸ ë°•ìŠ¤ ë†’ì´ê°€ fixedHeightë¥¼ ë„˜ì–´ê°€ë©´ í°íŠ¸ ì¤„ì„
        if (!textbox.fixedHeight) return;

        let size = maxFontSize;
        textbox.set('fontSize', size);
        
        // Fabric Textbox ë†’ì´ ê³„ì‚°: textbox.height * textbox.scaleY
        // í•˜ì§€ë§Œ TextboxëŠ” ë‚´ìš©ì— ë”°ë¼ heightê°€ ëŠ˜ì–´ë‚¨.
        // widthëŠ” ê³ ì •.
        
        while (textbox.height > textbox.fixedHeight && size > minFontSize) {
            size--;
            textbox.set('fontSize', size);
            // ê°•ì œ ë¦¬í”Œë¡œìš° ê°™ì€ íš¨ê³¼ë¥¼ ìœ„í•´ ë„ˆë¹„ ì¬ì„¤ì •
            textbox.set('width', textbox.width); 
        }
    }

    // --- 3. ì´ë¯¸ì§€ ë° GIF ì²˜ë¦¬ ---

    // GIF íŒŒì‹± ë° ì¬ìƒ ë£¨í”„
    function handleImageUpload(file, layerKey) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const result = e.target.result;
            
            // ê¸°ì¡´ ê°ì²´ ì œê±°
            if (layers[layerKey]) {
                // GIF ëª©ë¡ì—ì„œ ì œê±°
                const idx = activeGifs.findIndex(g => g.fabricObj === layers[layerKey]);
                if (idx > -1) activeGifs.splice(idx, 1);
                canvas.remove(layers[layerKey]);
            }

            if (file.type === 'image/gif') {
                // GIF ì²˜ë¦¬
                loadGif(result, layerKey);
            } else {
                // ì¼ë°˜ ì´ë¯¸ì§€ ì²˜ë¦¬
                fabric.Image.fromURL(result, function(img) {
                    setupLayerObj(img, layerKey);
                });
            }
        };
        reader.readAsDataURL(file);
    }

    function loadGif(dataUrl, layerKey) {
        const imgTag = document.createElement('img');
        imgTag.src = dataUrl;
        // SuperGifëŠ” DOM ìš”ì†Œê°€ í•„ìš”í•¨
        imgTag.style.display = 'none';
        document.body.appendChild(imgTag);

        const rubbableGif = new SuperGif({ gif: imgTag, auto_play: false } );
        rubbableGif.load(function() {
            // GIF ë¡œë“œ ì™„ë£Œ
            const gifCanvas = rubbableGif.get_canvas(); // í˜„ì¬ í”„ë ˆì„ì˜ ìº”ë²„ìŠ¤
            
            const fabricImg = new fabric.Image(gifCanvas, {
                objectCaching: false // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ìºì‹± ë”
            });

            setupLayerObj(fabricImg, layerKey);
            
            // ì• ë‹ˆë©”ì´ì…˜ ëª©ë¡ì— ë“±ë¡
            activeGifs.push({
                fabricObj: fabricImg,
                superGif: rubbableGif,
                canvasEl: gifCanvas
            });
            
            rubbableGif.play();
            // imgTagëŠ” SuperGif ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë˜ê±°ë‚˜ canvasë¡œ ëŒ€ì²´ë¨.
        });
    }

    function setupLayerObj(obj, layerKey) {
        // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (ì›ë³¸ CSS ì°¸ì¡°)
        let opts = {};
        if (layerKey === 'img1') opts = { left: 200, top: 0 }; // 700x440 fit needed? No, user scales it.
        if (layerKey === 'img2') opts = { left: 531, top: 470 };
        if (layerKey === 'img3') opts = { left: 635, top: 415 };

        obj.set({
            ...opts,
            originX: 'center', originY: 'center' // ì¡°ì‘ í¸ì˜ë¥¼ ìœ„í•´ ì¤‘ì‹¬ì  ë³€ê²½
        });
        
        // ì¤‘ì‹¬ì  ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ë³´ì •
        obj.set({
            left: opts.left + (obj.width * obj.scaleX / 2),
            top: opts.top + (obj.height * obj.scaleY / 2)
        });

        // ë„ˆë¬´ í¬ë©´ ì ë‹¹íˆ ì¤„ì´ê¸°
        if (obj.width > 500) obj.scaleToWidth(300);

        layers[layerKey] = obj;
        canvas.add(obj);
        canvas.setActiveObject(obj);
        
        // ë¼ë””ì˜¤ ë²„íŠ¼ ë™ê¸°í™”
        document.querySelector(`input[name="target"][value="layer${layerKey.slice(-1)}"]`).checked = true;
        
        reorderLayers();
        saveHistory();
    }

    // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
    function renderLoop() {
        if (activeGifs.length > 0) {
            let dirty = false;
            activeGifs.forEach(g => {
                // SuperGifê°€ ìº”ë²„ìŠ¤ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•¨
                // Fabric ê°ì²´ì— "ì†ŒìŠ¤ê°€ ë³€í–ˆë‹¤"ê³  ì•Œë ¤ì¤Œ
                g.fabricObj.dirty = true; 
                dirty = true;
            });
            if (dirty) canvas.requestRenderAll();
        }
        requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);


    // --- 4. ì´ë²¤íŠ¸ ì—°ê²° ---
    
    // ì—…ë¡œë“œ ë²„íŠ¼
    document.getElementById('img-input-1').addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'img1'));
    document.getElementById('img-input-2').addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'img2'));
    document.getElementById('img-input-3').addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'img3'));

    // íƒ€ê²Ÿ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼
    document.querySelectorAll('input[name="target"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const val = e.target.value;
            canvas.discardActiveObject();
            if (val !== 'none') {
                const map = { layer1: layers.img1, layer2: layers.img2, layer3: layers.img3 };
                if (map[val]) canvas.setActiveObject(map[val]);
            }
            canvas.requestRenderAll();
        });
    });

    // ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ ë¼ë””ì˜¤ ë²„íŠ¼ ë™ê¸°í™”
    canvas.on('selection:created', syncSelection);
    canvas.on('selection:updated', syncSelection);
    canvas.on('selection:cleared', () => {
        document.querySelector('input[name="target"][value="none"]').checked = true;
    });

    function syncSelection(e) {
        const obj = e.selected[0];
        if (obj === layers.img1) document.querySelector('input[value="layer1"]').checked = true;
        else if (obj === layers.img2) document.querySelector('input[value="layer2"]').checked = true;
        else if (obj === layers.img3) document.querySelector('input[value="layer3"]').checked = true;
        else document.querySelector('input[value="none"]').checked = true;
    }

    // ì¡°ì‘ ë²„íŠ¼
    window.resetActiveObject = () => {
        const obj = canvas.getActiveObject();
        if(obj) { obj.scale(1); obj.rotate(0); obj.set('flipX', false); canvas.requestRenderAll(); saveHistory(); }
    };
    window.rotateActiveObject = () => {
        const obj = canvas.getActiveObject();
        if(obj) { obj.rotate((obj.angle + 90) % 360); canvas.requestRenderAll(); saveHistory(); }
    };
    window.flipActiveObject = () => {
        const obj = canvas.getActiveObject();
        if(obj) { obj.set('flipX', !obj.flipX); canvas.requestRenderAll(); saveHistory(); }
    };

    // ëª¨ë°”ì¼ ëª¨ë“œ
    document.getElementById('mobile-mode-toggle').addEventListener('change', (e) => {
        const wrapper = document.getElementById('canvas-wrapper');
        if (e.target.checked) {
            document.body.classList.add('mobile-mode');
            // ìŠ¤ì¼€ì¼ ê³„ì‚°
            const scale = Math.min(window.innerWidth / 1050, 0.45);
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.marginTop = '-200px'; // ìŠ¤ì¼€ì¼ ë‹¤ìš´ ì‹œ ì—¬ë°± ì¡°ì •
        } else {
            document.body.classList.remove('mobile-mode');
            wrapper.style.transform = 'scale(1)';
            wrapper.style.marginTop = '0';
        }
    });

    // --- 5. íš¨ê³¼ (ë¡œê³ ) ---
    function updateLogoEffects() {
        if (!layers.img3) return;
        const shadowOn = document.getElementById('logo-shadow-toggle').checked;
        const borderOn = document.getElementById('logo-border-toggle').checked;
        const borderWidth = parseFloat(document.getElementById('logo-border-width').value);
        const borderColor = document.getElementById('logo-border-color').value;

        // Shadow
        if (shadowOn) {
            layers.img3.set('shadow', new fabric.Shadow({ color: 'rgba(0,0,0,0.9)', blur: 5, offsetX: 5, offsetY: 5 }));
        } else {
            layers.img3.set('shadow', null);
        }

        // Stroke (Fabric Image strokeëŠ” ì‚¬ê°í˜• í…Œë‘ë¦¬ë¼ ë¹„ì •í˜• ë¡œê³ ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŒ)
        // ë¹„ì •í˜• ì´ë¯¸ì§€ ì™¸ê³½ì„ ì€ Filterë¡œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ”ë° Fabric ê¸°ë³¸ í•„í„°ì—ëŠ” ì™¸ê³½ì„ ì´ ì—†ìŒ.
        // ì—¬ê¸°ì„œëŠ” Fabric Image Stroke(ì‚¬ê°í˜•) ëŒ€ì‹  Shadowë¥¼ ì´ìš©í•œ Fake Stroke ë˜ëŠ” ê·¸ëƒ¥ Strokeë¥¼ ì ìš©.
        // ì›ë³¸ ê¸°ëŠ¥: CSS drop-shadow 4ë°©í–¥. Fabricì—ì„œ ì´ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ filter backendë¥¼ ì¨ì•¼ í•¨.
        // ê°„ë‹¨íˆ Fabric strokeë¡œ êµ¬í˜„ (ì‚¬ê°í˜• ë°•ìŠ¤ ì³ì§) í•˜ê±°ë‚˜ ìƒëµ ê¶Œì¥.
        // ëŒ€ì•ˆ: í…ìŠ¤íŠ¸ì²˜ëŸ¼ strokeë¥¼ ì¤„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë¡œê³  í…Œë‘ë¦¬ëŠ” "ì •í˜•í™”ëœ ì´ë¯¸ì§€"ë¼ê³  ê°€ì •í•˜ê³  stroke ì ìš©.
        if (borderOn && borderWidth > 0) {
            layers.img3.set({
                stroke: borderColor,
                strokeWidth: borderWidth
            });
            // ë¡œê³ ê°€ íˆ¬ëª… ë°°ê²½ pngë¼ë©´ strokeëŠ” ë°•ìŠ¤ë¡œ ë‚˜ì˜´. 
            // ìº”ë²„ìŠ¤ ë ˆë²¨ì—ì„œ í”½ì…€ ë‹¨ìœ„ ì™¸ê³½ì„ ì„ ë”°ëŠ” ê±´ ì„±ëŠ¥ìƒ ë¬´ë¦¬.
            // ëŒ€ì•ˆ: ì´ë¯¸ì§€ë¥¼ ë³µì œí•´ì„œ ë’¤ì— ê¹”ê³  ìƒ‰ìƒì„ ì±„ì›Œì„œ ì¡°ê¸ˆ í‚¤ìš°ëŠ” ë°©ì‹(ë³µì¡í•¨).
            // ì—¬ê¸°ì„œëŠ” ì‹¬í”Œí•˜ê²Œ Shadowë¡œ ì™¸ê³½ì„  ëŠë‚Œ í‰ë‚´ (Glow)
             layers.img3.set('shadow', new fabric.Shadow({
                 color: borderColor, blur: 0, offsetX: borderWidth, offsetY: borderWidth
             }));
             // *ì •í™•í•œ CSS drop-shadow 4ë°©í–¥ êµ¬í˜„ì€ Fabric í•„í„° ì»¤ìŠ¤í…€ì´ í•„ìš”í•˜ì—¬ ìƒëµí•˜ê³  ë‹¨ì¼ ê·¸ë¦¼ìë¡œ ëŒ€ì²´*
        } else if (!shadowOn) {
             layers.img3.set('shadow', null);
        }

        canvas.requestRenderAll();
        saveHistory();
    }

    document.getElementById('logo-shadow-toggle').addEventListener('change', updateLogoEffects);
    document.getElementById('logo-border-toggle').addEventListener('change', () => {
        document.getElementById('logo-border-controls').style.display = document.getElementById('logo-border-toggle').checked ? 'block' : 'none';
        updateLogoEffects();
    });
    document.getElementById('logo-border-width').addEventListener('input', updateLogoEffects);
    document.getElementById('logo-border-color').addEventListener('input', updateLogoEffects);


    // --- 6. ì €ì¥ (GIF ë‚´ë³´ë‚´ê¸° í•µì‹¬) ---
    
    // gif.js ì›Œì»¤ ì¸ë¼ì¸ Blob ìƒì„± (ì™¸ë¶€ íŒŒì¼ ì˜ì¡´ì„± ì œê±°)
    const gifWorkerBlob = new Blob([`
        importScripts('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
    `], { type: 'application/javascript' });
    const workerUrl = URL.createObjectURL(gifWorkerBlob);

    document.getElementById('save-btn').addEventListener('click', async () => {
        canvas.discardActiveObject();
        canvas.requestRenderAll();

        const loading = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        loading.style.display = 'flex';

        if (activeGifs.length === 0) {
            // ì •ì  ì´ë¯¸ì§€ ì €ì¥
            loadingText.innerText = "ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
            setTimeout(() => {
                const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 });
                const link = document.createElement('a');
                link.download = 'í…ì¹´_ê²°ê³¼ë¬¼.png';
                link.href = dataURL;
                link.click();
                loading.style.display = 'none';
            }, 100);
            return;
        }

        // GIF ì €ì¥
        loadingText.innerText = "GIF í”„ë ˆì„ ë Œë”ë§ ì¤‘...";
        
        // 1. ê°€ì¥ ê¸´ GIF ì°¾ê¸°
        let maxFrames = 0;
        let mainGif = activeGifs[0];
        activeGifs.forEach(g => {
            if (g.superGif.get_length() > maxFrames) {
                maxFrames = g.superGif.get_length();
                mainGif = g;
            }
        });

        const gif = new GIF({
            workers: 4,
            quality: 10,
            width: 1024,
            height: 765,
            workerScript: workerUrl
        });

        // 2. í”„ë ˆì„ ìˆœíšŒ ë° ìº¡ì²˜
        // Fabric ìº”ë²„ìŠ¤ ìƒíƒœë¥¼ ë³€ê²½í•˜ë©° ìº¡ì²˜
        const totalDuration = mainGif.superGif.get_length();
        
        // ì• ë‹ˆë©”ì´ì…˜ ì ì‹œ ì¤‘ì§€
        activeGifs.forEach(g => g.superGif.pause());

        for (let i = 0; i < totalDuration; i++) {
            loadingText.innerText = `GIF ìƒì„± ì¤‘ (${i + 1}/${totalDuration})`;
            
            // ê° GIFë¥¼ ië²ˆì§¸ í”„ë ˆì„ìœ¼ë¡œ ì´ë™
            activeGifs.forEach(g => {
                const len = g.superGif.get_length();
                g.superGif.move_to(i % len); // ê¸¸ì´ê°€ ë‹¤ë¥´ë©´ ë°˜ë³µ
                g.fabricObj.dirty = true;
            });
            
            // Fabric ë Œë”ë§ (ë™ê¸°)
            canvas.renderAll();
            
            // í”„ë ˆì„ ì¶”ê°€
            // delayëŠ” ì›ë³¸ GIFì˜ delayë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
            // libgifëŠ” get_frame_delayë¥¼ ì œê³µí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë‹ˆ í‰ê·  100ms(10fps) ê°€ì •
            // ì •í™•íˆ í•˜ë ¤ë©´ superGif ë‚´ë¶€ ì ‘ê·¼ í•„ìš”. ì—¬ê¸°ì„  100ms ê³ ì •.
            gif.addFrame(canvas.getElement(), {delay: 100, copy: true});
            
            // UI ë¸”ë¡œí‚¹ ë°©ì§€
            await new Promise(r => setTimeout(r, 0));
        }

        loadingText.innerText = "ì¸ì½”ë”© ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
        
        gif.on('finished', function(blob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'í…ì¹´_ì›€ì§¤.gif';
            link.click();
            
            // ë³µêµ¬
            activeGifs.forEach(g => g.superGif.play());
            loading.style.display = 'none';
        });

        gif.render();
    });


    // --- 7. ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ (History) ---
    // Fabric state serialization ì´ìš©
    let stateHistory = [];
    let historyMods = 0;
    let isHistoryLocked = false;

    function saveHistory() {
        if (isHistoryLocked) return;
        // GIF ê°ì²´ ë“±ì€ JSON ë³€í™˜ ì‹œ ì†Œì‹¤ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ í•„ìš”.
        // ë‹¨ìˆœ ì¢Œí‘œ/í…ìŠ¤íŠ¸ ë³µêµ¬ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê³ , ì´ë¯¸ì§€ ì†ŒìŠ¤ëŠ” ìœ ì§€í•œë‹¤ê³  ê°€ì •.
        // ì „ì²´ ì§ë ¬í™”ëŠ” ì„±ëŠ¥ ì´ìŠˆ ë° GIF ì¬ìƒ ëŠê¹€ ìœ ë°œ.
        // ì—¬ê¸°ì„œëŠ” "í…ìŠ¤íŠ¸ ë‚´ìš©"ê³¼ "ê°ì²´ íŠ¸ëœìŠ¤í¼(ìœ„ì¹˜/í¬ê¸°)"ë§Œ ì €ì¥í•˜ëŠ” ê²½ëŸ‰í™” ë°©ì‹ ê¶Œì¥.
        
        const json = JSON.stringify(canvas.toJSON(['id', 'fixedHeight']));
        stateHistory.push(json);
        if(stateHistory.length > 20) stateHistory.shift();
        historyMods = 0;
    }

    function undo() {
        if (stateHistory.length < 2) return;
        isHistoryLocked = true;
        stateHistory.pop(); // í˜„ì¬ ìƒíƒœ ì œê±°
        const prevState = stateHistory[stateHistory.length - 1];
        loadState(prevState);
        isHistoryLocked = false;
    }

    function redo() {
        // Redo êµ¬í˜„ì„ ìœ„í•´ì„œëŠ” ë³„ë„ ìŠ¤íƒ í•„ìš”í•˜ë‚˜, ìš”ì²­ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ Undoë§Œ êµ¬í˜„
        // ë˜ëŠ” undo ì‹œ pointerë§Œ ì´ë™.
        alert('í˜„ì¬ ë˜ëŒë¦¬ê¸°(Undo)ë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
    }

    function loadState(json) {
        canvas.loadFromJSON(json, () => {
            // ë¡œë“œ í›„ ê°ì²´ ì°¸ì¡° ì¬ì—°ê²° (layers ê°ì²´ ì—…ë°ì´íŠ¸)
            canvas.getObjects().forEach(obj => {
                // ë ˆì´ì–´ ì‹ë³„ ë¡œì§ í•„ìš” (ì—¬ê¸°ì„  ìƒëµ, ë‹¨ìˆœ ì „ì²´ ë¡œë“œ)
                // GIFê°€ í¬í•¨ëœ ê²½ìš° ìƒˆë¡œ ë¡œë“œë˜ë©´ ì• ë‹ˆë©”ì´ì…˜ì´ ë©ˆì¶¤.
                // GIF ì§€ì› ì—ë””í„°ì—ì„œ Undo êµ¬í˜„ì€ ë§¤ìš° ë³µì¡í•˜ë¯€ë¡œ 
                // í…ìŠ¤íŠ¸/ìœ„ì¹˜ ë³€ê²½ë§Œ ë¡¤ë°±í•˜ëŠ” ê²ƒì´ ì•ˆì „í•¨.
                if(obj instanceof fabric.Textbox) {
                     // í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ ì¬ì—°ê²°
                     obj.on('changed', () => autoResizeFont(obj));
                }
            });
            reorderLayers();
            canvas.renderAll();
        });
    }
    
    // ì´ˆê¸° ìƒíƒœ ì €ì¥
    setTimeout(saveHistory, 1000);

    // í°íŠ¸ ìˆ˜ë™ ì¡°ì ˆ ì´ë²¤íŠ¸
    document.querySelectorAll('.font-slider').forEach(slider => {
        slider.addEventListener('input', (e) => {
            const id = e.target.dataset.id;
            const val = parseInt(e.target.value);
            if (layers[id]) {
                layers[id].set('fontSize', val);
                canvas.requestRenderAll();
            }
        });
    });

    // í°íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
    document.getElementById('font-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const fontFace = new FontFace('CustomFont', ev.target.result);
            await fontFace.load();
            document.fonts.add(fontFace);
            [layers.text_tl, layers.text_bl, layers.text_tr].forEach(t => {
                t.set('fontFamily', 'CustomFont');
                autoResizeFont(t);
            });
            canvas.requestRenderAll();
        };
        reader.readAsArrayBuffer(file);
    });
    
    // SteamGridDB ê²€ìƒ‰
    document.getElementById('sgdb-search-btn').addEventListener('click', function() {
        const term = document.getElementById('sgdb-input').value.trim();
        if (term) window.open(`https://www.steamgriddb.com/search/grids?term=${encodeURIComponent(term)}`, '_blank');
    });

</script>
</body>
</html>
