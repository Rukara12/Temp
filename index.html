<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í…ì¹´ í…œí”Œë¦¿ - ì—ë””í„° (Canvas Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
    <style>
        /* ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ì„ 100% ìœ ì§€í•©ë‹ˆë‹¤ */
        @font-face {
            font-family: 'PyeongtaekSunset';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408@1.0/PTNoeulL.woff2') format('woff2');
            font-weight: 300; font-display: swap;
        }
        @font-face {
            font-family: 'PyeongtaekSunset';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408@1.0/PTNoeulB.woff2') format('woff2');
            font-weight: 700; font-display: swap;
        }
        body { margin: 0; padding: 0; font-family: 'PyeongtaekSunset', sans-serif; background-color: #e9ecef; display: flex; height: 100vh; overflow: hidden; }
        body.mobile-mode { flex-direction: column; overflow-y: auto; height: auto; }
        .sidebar { width: 300px; background: #ffffff; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); overflow-y: auto; z-index: 10; }
        .sidebar.right { border-right: none; border-left: 1px solid #dee2e6; }
        body.mobile-mode .sidebar { width: 100%; border: none; order: 2; box-sizing: border-box; overflow-y: visible; }
        .main-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; position: relative; background: #ced4da; }
        #canvas-wrapper { position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); line-height: 0; }
        button { width: 100%; padding: 10px; font-size: 14px; cursor: pointer; border-radius: 6px; border: 1px solid #ced4da; font-weight: bold; margin-bottom: 8px; }
        .save-btn { background: #28a745; color: white; border: none; font-size: 16px; padding: 15px; margin-top: 10px; }
        .record-btn { background: #dc3545; color: white; border: none; font-size: 16px; padding: 15px; }
        .upload-btn { background: #007bff; color: white; border: none; }
        .control-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f1f3f5; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #495057; }
        .slider-item { margin: 8px 0; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .num-input { width: 50px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; }
        .hint { color: #868e96; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="control-section">
        <div class="section-title">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
        <button class="upload-btn" onclick="document.getElementById('file1').click()">ë§í’ì„  ì‚¬ì§„</button>
        <button class="upload-btn" onclick="document.getElementById('file2').click()">í•¸ë“œí° ì‚¬ì§„</button>
        <button class="upload-btn" onclick="document.getElementById('file3').click()">ë¡œê³  ì‚¬ì§„</button>
        <input type="file" id="file1" style="display:none" onchange="handleUpload(event, 1)">
        <input type="file" id="file2" style="display:none" onchange="handleUpload(event, 2)">
        <input type="file" id="file3" style="display:none" onchange="handleUpload(event, 3)">
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ” SteamGridDB ê²€ìƒ‰</div>
        <input type="text" id="sgdb-input" placeholder="ê²Œì„ëª… ì…ë ¥" style="width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box;">
        <button onclick="searchSGDB()">ê²€ìƒ‰í•˜ê¸°</button>
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ¬ ë…¹í™” ì œì–´ (Moving Image)</div>
        <button class="record-btn" id="record-btn" onclick="toggleRecording()">ë…¹í™” ì‹œì‘ (WebM)</button>
        <div id="record-status" style="text-align:center; color:red; font-weight:bold; margin-top:5px;"></div>
    </div>
</aside>

<main class="main-content">
    <div id="canvas-wrapper">
        <canvas id="main-canvas"></canvas>
    </div>
</main>

<aside class="sidebar right">
    <div class="control-section">
        <div class="section-title">âš™ï¸ í™˜ê²½ ì„¤ì •</div>
        <label><input type="checkbox" id="mobile-mode-toggle"> ëª¨ë°”ì¼ ìµœì í™” UI ëª¨ë“œ</label>
    </div>

    <div class="control-section">
        <div class="section-title">ğŸ”¤ í°íŠ¸ ì„¤ì •</div>
        <label><input type="checkbox" id="auto-font-toggle" checked> ìë™ í¬ê¸° ì¡°ì ˆ</label>
        <div id="manual-font-controls" style="display:none; margin-top:10px;">
            <div class="slider-item">ì¢Œìƒ: <input type="range" class="f-slider" data-id="b1" min="10" max="100" value="42"></div>
            <div class="slider-item">ì¢Œí•˜: <input type="range" class="f-slider" data-id="b2" min="10" max="100" value="42"></div>
            <div class="slider-item">ìš°ìƒ: <input type="range" class="f-slider" data-id="b3" min="10" max="100" value="42"></div>
        </div>
    </div>

    <div class="control-section">
        <div class="section-title">âœ¨ ë¡œê³  íš¨ê³¼</div>
        <label><input type="checkbox" id="logo-shadow-toggle"> ê·¸ë¦¼ì íš¨ê³¼</label>
        <label><input type="checkbox" id="logo-border-toggle" onchange="updateLogoEffects()"> í…Œë‘ë¦¬ ì„¤ì •</label>
        <div id="logo-border-controls" style="display:none; margin-top:10px;">
            <div class="slider-item">ë‘ê»˜: <input type="range" id="l-bw" min="0" max="10" step="0.5" value="2.5" oninput="updateLogoEffects()"></div>
            <div class="slider-item">ìƒ‰ìƒ: <input type="color" id="l-bc" value="#000000" oninput="updateLogoEffects()"></div>
        </div>
    </div>

    <div style="margin-top: auto;">
        <div style="display: flex; gap: 5px;">
            <button onclick="undo()">ë˜ëŒë¦¬ê¸°</button>
            <button onclick="redo()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
        <button class="save-btn" onclick="saveImage()">ìµœì¢… ê²°ê³¼ë¬¼ ì €ì¥ (PNG)</button>
    </div>
</aside>

<script>
    // [1] ì´ˆê¸° ìƒìˆ˜ ë° ë°ì´í„° (ìˆ˜ì¹˜ ë³´ì¡´)
    const CANVAS_W = 1024, CANVAS_H = 765;
    const layerConfigs = {
        1: { left: 200, top: 0, width: 700, height: 440, zIndex: 1 },
        2: { left: 531, top: 470, width: 90, height: 150, zIndex: 2 },
        3: { left: 635, top: 415, width: 380, height: 340, zIndex: 5 } // ë¡œê³ 
    };

    const canvas = new fabric.Canvas('main-canvas', {
        width: CANVAS_W, height: CANVAS_H,
        backgroundColor: '#fff', preserveObjectStacking: true
    });

    let capturer, isRecording = false;
    let history = [], historyIndex = -1, isStateSaving = false;

    // [2] ì´ˆê¸°í™”
    async function init() {
        // ë°°ê²½ ë¡œë“œ (z-index: 4 ì—­í• )
        fabric.Image.fromURL('tenka.png', (img) => {
            img.set({ selectable: false, evented: false, name: 'bg' });
            canvas.add(img);
            canvas.moveTo(img, 4);
            saveState();
        }, { crossOrigin: 'anonymous' });

        // ë§í’ì„  ì¶”ê°€ (ìœ„ì¹˜ ìˆ˜ì¹˜ ë³´ì¡´)
        addBubble('b1', 'í…ì¹´ì¨© ë°˜ë°•í•˜ëŠ” ë‚´ìš©Â·Â·Â·\në“£ê¸° ì‹«ì€ ë§Â·Â·Â·', 1, 1, 215, 330);
        addBubble('b2', 'ë‚˜ì¨© ë¯¸ì•ˆÂ·Â·Â· ì˜ ì•ˆ ë“¤ë ¤Â·Â·Â·\nì•„ë¬´íŠ¼ ì–´ì©Œêµ¬ ì €ì©Œêµ¬Â·Â·Â·', 1, 420, 230, 350);
        addBubble('b3', 'ë‚˜ì¨© ì´ê±° ë´ë´Â·Â·Â·!\nëŒ€ì¶© ì–´ì©Œêµ¬ ì €ì©Œêµ¬ ê°“ê²œÂ·Â·Â·!', 810, 1, 215, 410);

        setupEvents();
        animate();
    }

    function addBubble(id, text, l, t, w, h) {
        const tb = new fabric.Textbox(text, {
            id: id, left: l + 15, top: t + 15, width: w - 30,
            fontSize: 42, fontFamily: 'PyeongtaekSunset', fontWeight: 700,
            textAlign: 'center', splitByGrapheme: true, name: 'bubble'
        });
        canvas.add(tb);
        canvas.moveTo(tb, 6);
        
        tb.on('changed', () => { if(document.getElementById('auto-font-toggle').checked) autoFontSize(tb, h - 30); });
    }

    // [3] í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: ìë™ í°íŠ¸ ì¡°ì ˆ (ê¸°ì¡´ ê¸°ëŠ¥ ì´ì‹)
    function autoFontSize(obj, maxHeight) {
        let size = 42;
        obj.set('fontSize', size);
        while(obj.height > maxHeight && size > 12) {
            size--;
            obj.set('fontSize', size);
        }
        canvas.renderAll();
    }

    // [4] í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: ì´ë¯¸ì§€ ì²˜ë¦¬ ë° í•„í„°
    function handleUpload(e, id) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
            fabric.Image.fromURL(f.target.result, (img) => {
                const conf = layerConfigs[id];
                img.set({
                    left: conf.left, top: conf.top,
                    scaleX: conf.width / img.width, scaleY: conf.height / img.height,
                    layerId: id
                });
                const old = canvas.getObjects().find(o => o.layerId === id);
                if(old) canvas.remove(old);
                canvas.add(img);
                canvas.moveTo(img, conf.zIndex);
                if(id === 3) updateLogoEffects(); // ë¡œê³ ë©´ í•„í„° ì ìš©
                saveState();
            }, { crossOrigin: 'anonymous' });
        };
        reader.readAsDataURL(file);
    }

    function updateLogoEffects() {
        const logo = canvas.getObjects().find(o => o.layerId === 3);
        if(!logo) return;

        const isShadow = document.getElementById('logo-shadow-toggle').checked;
        const isBorder = document.getElementById('logo-border-toggle').checked;
        const bWidth = parseFloat(document.getElementById('l-bw').value);
        const bColor = document.getElementById('l-bc').value;

        document.getElementById('logo-border-controls').style.display = isBorder ? 'block' : 'none';

        // Fabric.js ë‚´ì¥ í•„í„° ë° ì†ì„± ì‚¬ìš©
        logo.set('shadow', isShadow ? new fabric.Shadow({ color: 'rgba(0,0,0,0.9)', blur: 5, offsetX: 5, offsetY: 5 }) : null);
        
        // í…Œë‘ë¦¬ íš¨ê³¼ (ìº”ë²„ìŠ¤ì—ì„œëŠ” strokeë¡œ êµ¬í˜„ ê°€ëŠ¥í•˜ë‚˜ ì´ë¯¸ì§€ëŠ” filterë‚˜ ë³„ë„ drawing í•„ìš”)
        // ì—¬ê¸°ì„œëŠ” ê°€ì¥ í¡ì‚¬í•œ shadow ì¤‘ì²© ë°©ì‹ì„ ì‚¬ìš©í•˜ê±°ë‚˜ object stroke í™œìš©
        logo.set({ stroke: isBorder ? bColor : null, strokeWidth: isBorder ? bWidth : 0 });
        
        canvas.renderAll();
    }

    // [5] ì‹¤í–‰ ì·¨ì†Œ / ë‹¤ì‹œ ì‹¤í–‰ (Undo/Redo)
    function saveState() {
        if(isStateSaving) return;
        const json = JSON.stringify(canvas.toObject(['layerId', 'id', 'name', 'selectable', 'evented']));
        history = history.slice(0, historyIndex + 1);
        history.push(json);
        historyIndex++;
        if(history.length > 30) { history.shift(); historyIndex--; }
    }

    function undo() {
        if(historyIndex <= 0) return;
        isStateSaving = true;
        canvas.loadFromJSON(history[--historyIndex], () => { canvas.renderAll(); isStateSaving = false; });
    }

    function redo() {
        if(historyIndex >= history.length - 1) return;
        isStateSaving = true;
        canvas.loadFromJSON(history[++historyIndex], () => { canvas.renderAll(); isStateSaving = false; });
    }

    // [6] ë…¹í™” ë£¨í”„
    function animate() {
        canvas.renderAll();
        if(isRecording && capturer) capturer.capture(canvas.getElement());
        requestAnimationFrame(animate);
    }

    function toggleRecording() {
        const btn = document.getElementById('record-btn');
        if(!isRecording) {
            capturer = new CCapture({ format: 'webm', framerate: 30, verbose: false });
            capturer.start();
            isRecording = true;
            btn.innerText = "ë…¹í™” ì¤‘ì§€ ë° ì €ì¥";
            document.getElementById('record-status').innerText = "â— RECORDING";
        } else {
            isRecording = false;
            capturer.stop();
            capturer.save();
            btn.innerText = "ë…¹í™” ì‹œì‘ (WebM)";
            document.getElementById('record-status').innerText = "";
        }
    }

    // ê¸°íƒ€ ë³´ì¡° ê¸°ëŠ¥ (SGDB, Mobile Mode ë“± ê¸°ì¡´ ë¡œì§ 100% ì´ì‹)
    function searchSGDB() {
        const term = document.getElementById('sgdb-input').value;
        if(term) window.open(`https://www.steamgriddb.com/search/grids?term=${encodeURIComponent(term)}`, '_blank');
    }

    document.getElementById('mobile-mode-toggle').addEventListener('change', (e) => {
        const wrapper = document.getElementById('canvas-wrapper');
        if(e.target.checked) {
            document.body.classList.add('mobile-mode');
            const scale = window.innerWidth / CANVAS_W * 0.9;
            wrapper.style.transform = `scale(${scale})`;
        } else {
            document.body.classList.remove('mobile-mode');
            wrapper.style.transform = `scale(1)`;
        }
    });

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'í…ì¹´_ê²°ê³¼ë¬¼.png';
        link.href = canvas.toDataURL({ format: 'png', multiplier: 2 });
        link.click();
    }

    function setupEvents() {
        canvas.on('object:modified', saveState);
        window.addEventListener('keydown', (e) => {
            if(e.ctrlKey && e.key === 'z') undo();
            if(e.ctrlKey && e.key === 'y') redo();
        });
    }

    window.onload = init;
</script>
</body>
</html>
