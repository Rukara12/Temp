<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í…ì¹´ í…œí”Œë¦¿ - ì• ë‹ˆë©”ì´ì…˜ ì—ë””í„° (Canvas)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'PyeongtaekSunset';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408@1.0/PTNoeulB.woff2') format('woff2');
            font-weight: 700;
        }
        body { margin: 0; display: flex; height: 100vh; background: #e9ecef; font-family: sans-serif; }
        .sidebar { width: 300px; background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
        .main-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .canvas-container { box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        button { width: 100%; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; font-weight: bold; }
        .save-btn { background: #28a745; color: white; border: none; padding: 15px; margin-top: 20px; }
        .record-btn { background: #dc3545; color: white; border: none; }
        .hint { font-size: 12px; color: #666; margin-top: 10px; }
        h3 { font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h3>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
    <button onclick="document.getElementById('file1').click()">ë§í’ì„  ì‚¬ì§„ (700x440)</button>
    <button onclick="document.getElementById('file2').click()">í•¸ë“œí° ì‚¬ì§„ (90x150)</button>
    <button onclick="document.getElementById('file3').click()">ë¡œê³  ì‚¬ì§„ (380x340)</button>
    <input type="file" id="file1" style="display:none" onchange="handleUpload(event, 1)">
    <input type="file" id="file2" style="display:none" onchange="handleUpload(event, 2)">
    <input type="file" id="file3" style="display:none" onchange="handleUpload(event, 3)">

    <h3>ğŸ¬ ë…¹í™” ì œì–´</h3>
    <button class="record-btn" id="record-toggle" onclick="toggleRecording()">ë…¹í™” ì‹œì‘ (WebM)</button>
    <div id="status" style="text-align: center; font-weight: bold; color: #dc3545; margin-top: 5px;"></div>
    
    <h3>ğŸ’¾ ìŠ¤ëƒ…ìƒ· ì €ì¥</h3>
    <button class="save-btn" onclick="saveImage()">ì´ë¯¸ì§€ë¡œ ì €ì¥ (PNG)</button>
    
    <div class="hint">
        * ìº”ë²„ìŠ¤ì˜ í…ìŠ¤íŠ¸ë¥¼ ë”ë¸” í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”.<br>
        * ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì¡°ì •í•˜ì„¸ìš”.
    </div>
</aside>

<main class="main-content">
    <canvas id="c"></canvas>
</main>

<script>
    // [1] ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° (ê¸°ì¡´ ìˆ˜ì¹˜ ìœ ì§€)
    const CANVAS_WIDTH = 1024;
    const CANVAS_HEIGHT = 765;
    const layers = {
        1: { left: 200, top: 0, width: 700, height: 440 },
        2: { left: 531, top: 470, width: 90, height: 150 },
        3: { left: 635, top: 415, width: 380, height: 340 }
    };
    
    const canvas = new fabric.Canvas('c', {
        width: CANVAS_WIDTH,
        height: CANVAS_HEIGHT,
        backgroundColor: '#fff',
        preserveObjectStacking: true
    });

    let capturer = null;
    let isRecording = false;

    // [2] ë ˆì´ì–´ ë° í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    async function init() {
        // ë°°ê²½ ì´ë¯¸ì§€ (tenka.png)
        fabric.Image.fromURL('tenka.png', (img) => {
            img.set({ selectable: false, evented: false, zIndex: 4 });
            canvas.add(img);
            canvas.moveTo(img, 4); // ë°°ê²½ ë ˆì´ì–´ ìœ„ì¹˜ ê³ ì •
        }, { crossOrigin: 'anonymous' });

        // ë§í’ì„  í…ìŠ¤íŠ¸ ì¶”ê°€ (ê¸°ì¡´ ìœ„ì¹˜/í¬ê¸° ìˆ˜ì¹˜ ì ìš©)
        addBubbleText('bubble1', 'í…ì¹´ì¨© ë°˜ë°•í•˜ëŠ” ë‚´ìš©Â·Â·Â·\në“£ê¸° ì‹«ì€ ë§Â·Â·Â·', 1, 1, 215, 330);
        addBubbleText('bubble2', 'ë‚˜ì¨© ë¯¸ì•ˆÂ·Â·Â· ì˜ ì•ˆ ë“¤ë ¤Â·Â·Â·\nì•„ë¬´íŠ¼ ì–´ì©Œêµ¬ ì €ì©Œêµ¬Â·Â·Â·', 1, 420, 230, 350);
        addBubbleText('bubble3', 'ë‚˜ì¨© ì´ê±° ë´ë´Â·Â·Â·!\nëŒ€ì¶© ì–´ì©Œêµ¬ ì €ì©Œêµ¬ ê°“ê²œÂ·Â·Â·!', 810, 1, 215, 410);

        renderLoop();
    }

    function addBubbleText(id, defaultText, left, top, width, height) {
        const text = new fabric.Textbox(defaultText, {
            left: left + 15,
            top: top + 15,
            width: width - 30,
            fontSize: 28,
            fontFamily: 'PyeongtaekSunset',
            fontWeight: 'bold',
            textAlign: 'center',
            editable: true,
            zIndex: 6
        });
        canvas.add(text);
    }

    // [3] ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    function handleUpload(e, layerId) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(f) {
            fabric.Image.fromURL(f.target.result, (img) => {
                const config = layers[layerId];
                img.set({
                    left: config.left,
                    top: config.top,
                    // ë ˆì´ì–´ í¬ê¸°ì— ë§ì¶° ì´ˆê¸° ìŠ¤ì¼€ì¼ ì¡°ì ˆ
                    scaleX: config.width / img.width,
                    scaleY: config.height / img.height
                });
                
                // ê¸°ì¡´ì— í•´ë‹¹ ë ˆì´ì–´ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ êµì²´
                const oldImg = canvas.getObjects().find(obj => obj.layerId === layerId);
                if (oldImg) canvas.remove(oldImg);
                
                img.layerId = layerId;
                canvas.add(img);
                
                // ë ˆì´ì–´ ìˆœì„œ ì¡°ì • (ë°°ê²½ ë’¤ë¡œ ë³´ë‚´ê¸°)
                if (layerId === 1 || layerId === 2) canvas.sendToBack(img);
                else canvas.bringToFront(img); // ë¡œê³  ë“±ì€ ì•ìª½
                
            }, { crossOrigin: 'anonymous' });
        };
        reader.readAsDataURL(file);
    }

    // [4] ë…¹í™” ë° ë Œë”ë§ ë£¨í”„ (í•µì‹¬)
    function renderLoop() {
        canvas.renderAll();
        if (isRecording && capturer) {
            capturer.capture(canvas.getElement());
        }
        requestAnimationFrame(renderLoop);
    }

    function toggleRecording() {
        const btn = document.getElementById('record-toggle');
        const status = document.getElementById('status');

        if (!isRecording) {
            // ë…¹í™” ì‹œì‘
            capturer = new CCapture({ 
                format: 'webm', 
                framerate: 30,
                verbose: false,
                display: false
            });
            capturer.start();
            isRecording = true;
            btn.innerText = "ë…¹í™” ì¤‘ì§€ ë° ì €ì¥";
            status.innerText = "ğŸ”´ RECORDING...";
        } else {
            // ë…¹í™” ì¢…ë£Œ
            isRecording = false;
            capturer.stop();
            capturer.save();
            btn.innerText = "ë…¹í™” ì‹œì‘ (WebM)";
            status.innerText = "";
        }
    }

    function saveImage() {
        const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
        const link = document.createElement('a');
        link.download = 'í…ì¹´_ê²°ê³¼ë¬¼.png';
        link.href = dataURL;
        link.click();
    }

    window.onload = init;
</script>

</body>
</html>
